# API de Controle de Estoque e Vendas

API REST desenvolvida em Laravel para gerenciar um m√≥dulo simplificado de controle de estoque e vendas para um ERP.

## üìã √çndice

- [Tecnologias](#tecnologias)
- [Funcionalidades](#funcionalidades)
- [Instala√ß√£o com Docker](#instala√ß√£o-com-docker)
- [Instala√ß√£o Local](#instala√ß√£o-local)
- [Configura√ß√£o do Ambiente](#configura√ß√£o-do-ambiente)
- [Comandos √öteis](#comandos-√∫teis)
- [Endpoints da API](#endpoints-da-api)
- [Testes](#testes)
- [Troubleshooting](#troubleshooting)
- [Documenta√ß√£o Adicional](#documenta√ß√£o-adicional)

## üöÄ Tecnologias

- **Laravel 12**
- **PHP 8.2**
- **PostgreSQL 16**
- **Docker & Docker Compose**
- **Nginx**
- **PHPUnit** para testes
- **Swagger/OpenAPI** para documenta√ß√£o

## ‚ú® Funcionalidades

### 1. Gerenciamento de Produtos
- ‚úÖ Listar todos os produtos com informa√ß√µes de estoque
- ‚úÖ Criar novos produtos com valida√ß√£o de dados
- ‚úÖ Consultar detalhes de produtos incluindo invent√°rio
- ‚úÖ Atualizar produtos existentes
- ‚úÖ Deletar produtos
- ‚úÖ Valida√ß√£o de SKU √∫nico
- ‚úÖ Valida√ß√£o de pre√ßo de venda maior que custo
- ‚úÖ C√°lculo autom√°tico de margem de lucro e lucro unit√°rio

### 2. Gerenciamento de Estoque
- ‚úÖ Registrar entrada de produtos no estoque
- ‚úÖ Consultar estoque atual com valores totais
- ‚úÖ Calcular lucro projetado
- ‚úÖ Resumo consolidado do invent√°rio (total de itens, unidades, custos e valores)
- ‚úÖ C√°lculo de margem de lucro percentual
- ‚úÖ Incremento autom√°tico de estoque para produtos existentes

### 3. Processamento de Vendas
- ‚úÖ Registrar vendas com m√∫ltiplos itens
- ‚úÖ C√°lculo autom√°tico de valor total e margem de lucro
- ‚úÖ Consultar detalhes de vendas
- ‚úÖ Atualiza√ß√£o autom√°tica de estoque via eventos
- ‚úÖ Valida√ß√£o de estoque dispon√≠vel antes da venda
- ‚úÖ C√°lculo de lucro por item e total
- ‚úÖ Evento `SaleCompleted` disparado ap√≥s venda bem-sucedida

## üê≥ Instala√ß√£o com Docker (Recomendado)

### Pr√©-requisitos
- Docker
- Docker Compose

### Servi√ßos Docker
- **app**: Aplica√ß√£o Laravel (PHP 8.2-FPM)
- **nginx**: Servidor web (Nginx Alpine)
- **db**: Banco de dados PostgreSQL 16
- **pgadmin**: Interface web para gerenciar PostgreSQL (opcional)

### Passo a Passo

#### 1. Clone o reposit√≥rio
```bash
git clone <repository-url>
cd php-teste-pleno
```

#### 2. Configure as vari√°veis de ambiente
```bash
cp .env.docker .env
```

#### 3. Construir e iniciar os containers
```bash
docker compose up -d --build
```

Este comando ir√°:
- Construir a imagem Docker da aplica√ß√£o
- Iniciar todos os servi√ßos (app, nginx, db, pgadmin)
- Criar o volume para persist√™ncia do PostgreSQL

#### 4. Gerar a chave da aplica√ß√£o
```bash
docker compose exec app php artisan key:generate
```

#### 5. Executar as migrations
```bash
docker compose exec app php artisan migrate
```

#### 6. Popular o banco de dados (opcional)
```bash
docker compose exec app php artisan db:seed
```

#### 7. Instalar depend√™ncias do Swagger (opcional)
```bash
docker compose exec app composer require darkaonline/l5-swagger
docker compose exec app php artisan vendor:publish --provider "L5Swagger\L5SwaggerServiceProvider"
docker compose exec app php artisan l5-swagger:generate
```

### Acessar a Aplica√ß√£o

- **API**: http://localhost:8000
- **Documenta√ß√£o Swagger**: http://localhost:8000/api/documentation
- **PgAdmin**: http://localhost:5050
  - Email: admin@admin.com
  - Senha: admin

### Configura√ß√£o do PostgreSQL

**Credenciais padr√£o:**
- **Host**: db (dentro do Docker) ou localhost (fora do Docker)
- **Porta**: 5432
- **Database**: api_estoque
- **Username**: laravel
- **Password**: secret

**Conectar ao PostgreSQL via PgAdmin:**
1. Acesse http://localhost:5050
2. Fa√ßa login com as credenciais acima
3. Adicione um novo servidor:
   - **Host**: db
   - **Port**: 5432
   - **Database**: api_estoque
   - **Username**: laravel
   - **Password**: secret

## üíª Instala√ß√£o Local

### Pr√©-requisitos
- PHP 8.2 ou superior
- Composer
- PostgreSQL 16
- Node.js e NPM

### Passo a Passo

#### 1. Instalar depend√™ncias
```bash
composer install
npm install
```

#### 2. Configurar ambiente
```bash
cp .env.example .env
php artisan key:generate
```

#### 3. Configurar banco de dados no `.env`
```env
DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=api_estoque
DB_USERNAME=seu_usuario
DB_PASSWORD=sua_senha
```

#### 4. Executar migrations e seeders
```bash
php artisan migrate
php artisan db:seed
```

#### 5. Iniciar o servidor
```bash
php artisan serve
```

## üìù Comandos √öteis

### Comandos Docker

#### Ver logs dos containers
```bash
# Todos os servi√ßos
docker compose logs -f

# Apenas a aplica√ß√£o
docker compose logs -f app

# Apenas o banco de dados
docker compose logs -f db
```

#### Executar comandos Artisan
```bash
docker compose exec app php artisan [comando]
```

**Exemplos:**
```bash
# Criar migration
docker compose exec app php artisan make:migration create_users_table

# Criar controller
docker compose exec app php artisan make:controller UserController

# Limpar cache
docker compose exec app php artisan cache:clear

# Executar seeders
docker compose exec app php artisan db:seed
```

#### Acessar o container
```bash
# Acessar bash do container da aplica√ß√£o
docker compose exec app bash

# Acessar PostgreSQL CLI
docker compose exec db psql -U laravel -d api_estoque
```

#### Gerenciar containers
```bash
# Parar os containers
docker compose down

# Parar e remover volumes (CUIDADO: apaga o banco de dados)
docker compose down -v

# Reconstruir os containers
docker compose up -d --build --force-recreate
```

#### Ajustar permiss√µes (se necess√°rio)
```bash
docker compose exec app chown -R laravel:www-data /var/www
docker compose exec app chmod -R 775 /var/www/storage /var/www/bootstrap/cache
```

### Comandos com Makefile

Se voc√™ tiver o Makefile configurado:
```bash
# Setup completo
make setup

# Executar testes
make test

# Limpar cache
make cache-clear

# Acessar shell do container
make shell

# Acessar PostgreSQL
make db-shell

# Ver logs
make logs

# Reiniciar containers
make restart

# Executar migrations
make migrate

# Popular banco de dados
make seed
```

## üì° Endpoints da API

### Base URL
```
http://localhost:8000/api/v1
```

Para documenta√ß√£o completa dos endpoints, consulte:
- **Swagger UI**: http://localhost:8000/api/documentation
- **Arquivo**: [API_README.md](./API_README.md)

### Principais Endpoints

- **GET** `/api/v1/products` - Listar produtos
- **POST** `/api/v1/products` - Criar produto
- **GET** `/api/v1/products/{id}` - Detalhes do produto
- **PUT** `/api/v1/products/{id}` - Atualizar produto
- **DELETE** `/api/v1/products/{id}` - Deletar produto
- **GET** `/api/v1/inventory` - Consultar estoque
- **POST** `/api/v1/inventory` - Adicionar ao estoque
- **POST** `/api/v1/sales` - Criar venda
- **GET** `/api/v1/sales/{id}` - Detalhes da venda

## üß™ Testes

A aplica√ß√£o possui uma cobertura completa de testes, incluindo testes unit√°rios e de integra√ß√£o.

### Executar todos os testes
```bash
# Com Docker
docker compose exec app php artisan test

# Local
php artisan test
```

### Executar testes espec√≠ficos
```bash
# Testes unit√°rios
docker compose exec app php artisan test --testsuite=Unit

# Testes de feature
docker compose exec app php artisan test --testsuite=Feature

# Teste espec√≠fico
docker compose exec app php artisan test --filter=InventoryServiceTest
```

### Cobertura de Testes
```bash
docker compose exec app php artisan test --coverage
```

### Su√≠tes de Testes

#### Testes Unit√°rios (Services)
- **ProductServiceTest**: 10 testes
  - CRUD completo de produtos
  - Valida√ß√£o de relacionamentos
  - Tratamento de erros
  
- **InventoryServiceTest**: 5 testes
  - Adi√ß√£o de estoque
  - Verifica√ß√£o de disponibilidade
  - C√°lculos de valores e lucros
  - Resumo consolidado
  
- **SaleServiceTest**: 5 testes
  - Cria√ß√£o de vendas
  - Valida√ß√£o de estoque
  - C√°lculos de totais e margens
  - Disparo de eventos

#### Testes de Integra√ß√£o (API)
- **ProductApiTest**: 14 testes
  - Endpoints CRUD completos
  - Valida√ß√µes de dados
  - Tratamento de erros HTTP
  - Integra√ß√£o com invent√°rio
  
- **InventoryApiTest**: 6 testes
  - Adi√ß√£o de estoque via API
  - Consulta de status
  - Valida√ß√µes de entrada
  - C√°lculos de resumo
  
- **SaleApiTest**: 8 testes
  - Cria√ß√£o de vendas via API
  - Valida√ß√£o de estoque dispon√≠vel
  - Atualiza√ß√£o autom√°tica de invent√°rio
  - Vendas com m√∫ltiplos itens

**Total**: 48 testes automatizados

## üêõ Troubleshooting

### Erro de conex√£o com o banco de dados

Certifique-se de que:
1. O servi√ßo `db` est√° rodando: `docker compose ps`
2. As credenciais no `.env` est√£o corretas
3. O host do banco √© `db` (n√£o `localhost` ou `127.0.0.1`)
4. Aguarde o PostgreSQL ficar pronto

O Docker Compose inclui um healthcheck que garante que o PostgreSQL esteja pronto antes de iniciar a aplica√ß√£o.

### Erro de permiss√£o

Execute:
```bash
docker compose exec app chmod -R 775 storage bootstrap/cache
```

### Container n√£o inicia

Verifique os logs:
```bash
docker compose logs app
docker compose logs db
```

### Porta j√° em uso

Se a porta 8000 ou 5432 j√° estiver em uso, edite o `docker-compose.yml` e altere as portas:

```yaml
ports:
  - "8001:80"  # Altere 8000 para 8001
```

## üîÑ Atualizar a Aplica√ß√£o

Ap√≥s fazer altera√ß√µes no c√≥digo:

```bash
# Se alterou depend√™ncias do Composer
docker compose exec app composer install

# Se alterou depend√™ncias do NPM
docker compose exec app npm install
docker compose exec app npm run build

# Se alterou migrations
docker compose exec app php artisan migrate

# Se alterou configura√ß√µes
docker compose exec app php artisan config:clear
docker compose exec app php artisan cache:clear
```

## üìö Documenta√ß√£o Adicional

- [API_README.md](./API_README.md) - Documenta√ß√£o completa da API com exemplos de requisi√ß√µes e respostas
- [DOCKER_README.md](./DOCKER_README.md) - Documenta√ß√£o detalhada do ambiente Docker
- [Documenta√ß√£o do Laravel](https://laravel.com/docs)
- [Documenta√ß√£o do Docker](https://docs.docker.com/)
- [Documenta√ß√£o do PostgreSQL](https://www.postgresql.org/docs/)

## üèóÔ∏è Estrutura do Projeto

```
app/
‚îú‚îÄ‚îÄ Events/              # Eventos da aplica√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ SaleCompleted.php
‚îú‚îÄ‚îÄ Listeners/           # Listeners de eventos
‚îÇ   ‚îî‚îÄ‚îÄ UpdateInventoryOnSale.php
‚îú‚îÄ‚îÄ Models/              # Models Eloquent
‚îÇ   ‚îú‚îÄ‚îÄ Product.php
‚îÇ   ‚îú‚îÄ‚îÄ Inventory.php
‚îÇ   ‚îî‚îÄ‚îÄ Sale.php
‚îú‚îÄ‚îÄ Services/            # Camada de servi√ßos (l√≥gica de neg√≥cio)
‚îÇ   ‚îú‚îÄ‚îÄ ProductService.php
‚îÇ   ‚îú‚îÄ‚îÄ InventoryService.php
‚îÇ   ‚îî‚îÄ‚îÄ SaleService.php
‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/Api/ # Controllers da API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InventoryController.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SaleController.php
‚îÇ   ‚îî‚îÄ‚îÄ Requests/        # Form Requests (valida√ß√£o)
‚îÇ       ‚îú‚îÄ‚îÄ CreateProductRequest.php
‚îÇ       ‚îú‚îÄ‚îÄ UpdateProductRequest.php
‚îÇ       ‚îú‚îÄ‚îÄ AddInventoryRequest.php
‚îÇ       ‚îî‚îÄ‚îÄ CreateSaleRequest.php
‚îî‚îÄ‚îÄ Providers/           # Service Providers
    ‚îî‚îÄ‚îÄ EventServiceProvider.php

database/
‚îú‚îÄ‚îÄ migrations/          # Migrations do banco
‚îú‚îÄ‚îÄ seeders/            # Seeders
‚îî‚îÄ‚îÄ factories/          # Factories para testes

tests/
‚îú‚îÄ‚îÄ Unit/               # Testes unit√°rios (Services)
‚îÇ   ‚îú‚îÄ‚îÄ ProductServiceTest.php
‚îÇ   ‚îú‚îÄ‚îÄ InventoryServiceTest.php
‚îÇ   ‚îî‚îÄ‚îÄ SaleServiceTest.php
‚îî‚îÄ‚îÄ Feature/            # Testes de integra√ß√£o (API)
    ‚îú‚îÄ‚îÄ ProductApiTest.php
    ‚îú‚îÄ‚îÄ InventoryApiTest.php
    ‚îî‚îÄ‚îÄ SaleApiTest.php
```

## üéØ Arquitetura e Padr√µes

### Camadas da Aplica√ß√£o

1. **Controllers (API Layer)**
   - Recebem requisi√ß√µes HTTP
   - Validam dados via Form Requests
   - Delegam l√≥gica de neg√≥cio para Services
   - Retornam respostas JSON padronizadas

2. **Services (Business Logic Layer)**
   - Cont√™m toda a l√≥gica de neg√≥cio
   - Interagem com Models
   - Disparam eventos quando necess√°rio
   - Isolam regras de neg√≥cio dos controllers

3. **Models (Data Layer)**
   - Representam entidades do banco de dados
   - Definem relacionamentos
   - Cont√™m accessors e mutators

4. **Events & Listeners**
   - `SaleCompleted`: Disparado ap√≥s cria√ß√£o de venda
   - `UpdateInventoryOnSale`: Atualiza estoque automaticamente

### Padr√µes Utilizados

- **Service Layer Pattern**: Separa√ß√£o da l√≥gica de neg√≥cio
- **Repository Pattern** (via Eloquent): Abstra√ß√£o de acesso a dados
- **Event-Driven Architecture**: Desacoplamento via eventos
- **Form Request Validation**: Valida√ß√£o centralizada
- **Dependency Injection**: Inje√ß√£o de depend√™ncias via constructor
- **RESTful API**: Endpoints seguindo conven√ß√µes REST

### Regras de Neg√≥cio e Valida√ß√µes

#### Produtos
- SKU deve ser √∫nico no sistema
- Pre√ßo de venda deve ser maior que o pre√ßo de custo
- Campos obrigat√≥rios: `sku`, `name`, `cost_price`, `sale_price`
- Margem de lucro calculada automaticamente: `((sale_price - cost_price) / cost_price) * 100`
- Lucro unit√°rio calculado: `sale_price - cost_price`

#### Invent√°rio
- Quantidade deve ser um n√∫mero positivo (maior que zero)
- Product ID deve corresponder a um produto existente
- Ao adicionar estoque para produto existente, a quantidade √© incrementada
- C√°lculos autom√°ticos:
  - `total_cost = quantity * product.cost_price`
  - `total_value = quantity * product.sale_price`
  - `projected_profit = total_value - total_cost`

#### Vendas
- Deve conter pelo menos um item
- Todos os produtos devem existir no sistema
- Estoque deve ser suficiente para todos os itens
- Atualiza√ß√£o de estoque √© autom√°tica via evento `SaleCompleted`
- C√°lculos autom√°ticos por item:
  - `subtotal = quantity * product.sale_price`
  - `cost = quantity * product.cost_price`
  - `profit = subtotal - cost`
- C√°lculos totais da venda:
  - `total_amount = soma de todos os subtotais`
  - `total_cost = soma de todos os custos`
  - `total_profit = total_amount - total_cost`
  - `profit_margin = (total_profit / total_amount) * 100`

## ü§ù Contribuindo

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT.
